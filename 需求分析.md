## 背景

## 难点

- id 设计

  - 全局唯一性

    在分布式系统中,需要保证不同机器生成的ID不会冲突,要实现全局唯一。常见的解决方案是结合机器ID和本地计数器来生成ID。

  - 顺序性

    即保证ID按照生成顺序排列,这个在数据库主键和排序场景会用到。可以通过利用计数器实现。

- 性能

  需要保证ID生成的性能和可用性,不会成为系统瓶颈。一般采用缓存+批量预取、异步生成等手段。	

- 计数周期问题

  如果使用计数器,需要考虑计数周期循环导致的重复ID问题,SETTING时间回拨等情况。

- 单点故障和可扩展性

  任何单点和资源瓶颈都会导致系统不可用,需要支持动态扩容。

- 参数配置

  考虑时钟回拨、节点重启等情况,需要能动态调整参数。

- 监控

  要有监控指标确保系统稳定运行,并且可以快速发现和定位问题。

- 部署运维

  要简化系统部署运维,自动发现机器节点加入等。

## 设计

### id 生成算法：Leaf-snowflake and Leaf-segment

- 补充点：对于 Leaf-snowflake 人为设定起始时间，手动减少时间暴露可能性，和提高id数
- 由于雪花算法是强依赖于时间的，在分布式环境下，如果发生时钟回拨，很可能会引起id冲突的问题。解决方案有：
  - 将ID生成交给少量服务器，并关闭时钟同步。
  - 直接报错，交给上层业务处理。
  - 如果回拨时间较短，在耗时要求内，比如5ms，那么等待回拨时长后再进行生成。
  - 如果回拨时间很长，那么无法等待，可以匀出少量位（1~2位）作为回拨位，一旦时钟回拨，将回拨位加1，可得到不一样的ID，2位回拨位允许标记三次时钟回拨，基本够使用。如果超出了，可以再选择抛出异常。

### API 设计

生成趋势递增的ID，同时ID号是可计算的 申请

无序ID 申请

## 参考资料

- [Leaf——美团点评分布式ID生成系统](https://tech.meituan.com/2017/04/21/mt-leaf.html)